{$APPTYPE CONSOLE}

uses Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
     Dialogs, StdCtrls, ExtCtrls, FileCtrl, shellapi;

procedure KillProgram(ClassName: PChar; WindowTitle: PChar);
const PROCESS_TERMINATE = $0001;
var ProcessHandle:THandle; ProcessID:Integer; TheWindow:HWND;
begin
TheWindow:=FindWindow(Classname, WindowTitle);
GetWindowThreadProcessID(TheWindow, @ProcessID);
ProcessHandle:=OpenProcess(PROCESS_TERMINATE, FALSE, ProcessId);
TerminateProcess(ProcessHandle,4);
end;

procedure kill;
begin
Killprogram(nil,pchar(extractfilepath(application.exename)+'atester.exe'));
Sleep(100);
end;

procedure SelfEfface;
var F: Textfile;
begin
 AssignFile(F,Changefileext(Paramstr(0),'.bat'));
 Rewrite(F);
 Writeln(F,':1');
 Writeln(F, Format('Erase "%s"',[Paramstr(0)]));
 Writeln(F, Format('If exist "%s" Goto 1',[Paramstr(0)]));
 Writeln(F, Format('Erase "%s"',[ChangeFileExt(Paramstr(0),'.bat')]));
 CloseFile(F);
 WinExec(PChar(ChangeFileExt(Paramstr(0),'.bat')),SW_HIDE);
 Halt;
end;

begin
kill;
sleep(100);
deletefile(extractfilepath(application.ExeName)+'atester.exe');
renamefile(extractfilepath(application.ExeName)+'new.exe',extractfilepath(application.ExeName)+'atester.exe');
winexec('atester.exe',sw_show);
selfefface;
end.
 